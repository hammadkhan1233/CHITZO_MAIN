<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Futuristic P2P Chat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Base & Colors */
        :root {
            --bg-dark: #0f172a; /* Deep Blue/Black */
            --card-dark: #1e293b;
            --primary-color: #7c3aed; /* Deep Purple */
            --accent-color: #38bdf8; /* Cyan/Blue */
            --error-color: #f87171;
            --success-color: #34d399;
        }

        body { 
            background: var(--bg-dark); 
            color: #e2e8f0; 
            font-family: 'Poppins', sans-serif; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            min-height: 100vh; 
            margin: 0; 
            padding: 20px 0;
        }
        h1, h2 { color: var(--primary-color); font-weight: 700; margin-bottom: 20px; text-shadow: 0 0 5px rgba(124, 58, 237, 0.5); }
        h3 { color: #94a3b8; }

        /* Glassmorphism Card Style */
        .card-box {
            background: rgba(30, 41, 59, 0.6); /* Slightly transparent background */
            backdrop-filter: blur(10px); /* Blur effect */
            border: 1px solid rgba(124, 58, 237, 0.4); /* Subtle purple border */
            padding: 40px;
            border-radius: 18px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
            text-align: center;
            width: 90%;
            max-width: 450px;
            margin-bottom: 30px;
        }

        /* Input and Button Styling */
        input[type="text"] {
            width: calc(100% - 24px);
            padding: 14px;
            margin: 10px 0;
            border: 1px solid var(--accent-color);
            border-radius: 8px;
            background: rgba(51, 65, 85, 0.8);
            color: #e2e8f0;
            box-sizing: border-box;
            font-weight: 300;
        }
        button { 
            padding: 14px 30px; 
            font-size: 18px; 
            background: var(--primary-color);
            color: white; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            margin-top: 20px; 
            transition: background 0.3s, transform 0.1s;
        }
        button:hover:not(:disabled) { background: #9333ea; transform: translateY(-2px); }
        button:disabled { background: #475569; cursor: not-allowed; }

        /* Main Layout */
        #main-content { 
            display: flex; 
            width: 95%; 
            max-width: 1400px; 
            gap: 30px; 
            min-height: 700px; 
            align-items: flex-start;
        }
        #video-section { 
            flex: 2; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
        }
        
        /* Chat Section */
        #chat-section { 
            flex: 1; 
            display: none; 
            min-width: 350px; 
            height: 650px; 
            background: rgba(30, 41, 59, 0.6); 
            backdrop-filter: blur(10px);
            border: 1px solid rgba(56, 189, 248, 0.4); 
            padding: 20px; 
            border-radius: 18px; 
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }

        /* Video Containers */
        #video-container { 
            display: flex; 
            gap: 20px; 
            width: 100%; 
            height: 480px; 
            display: none; 
            margin-top: 15px;
        }
        video { 
            width: 50%; 
            border-radius: 12px; 
            background: #000; 
            border: 3px solid var(--primary-color); 
            box-shadow: 0 0 15px rgba(124, 58, 237, 0.6);
            transition: opacity 0.3s;
        }
        #tempVideo { border: 3px solid var(--error-color); }

        /* Control Buttons */
        .control-btn {
            background: var(--card-dark);
            color: var(--accent-color);
            padding: 12px 20px;
            margin: 5px;
            font-size: 16px;
            border: 1px solid var(--accent-color);
            border-radius: 50px; /* Pill shape */
            transition: background 0.3s, color 0.3s;
        }
        .control-btn:hover { background: var(--accent-color); color: var(--bg-dark); }

        /* Chat Specific */
        #messages { 
            height: 85%; 
            overflow-y: scroll; 
            margin-bottom: 15px; 
            padding: 10px; 
            background: var(--card-dark); 
            border-radius: 8px; 
            border: 1px solid rgba(71, 85, 105, 0.5);
        }
        .my-msg { text-align: right; color: var(--success-color); }
        .stranger-msg { text-align: left; color: #cbd5e1; }
        .error-msg { color: var(--error-color); }
        
        #message-input-container {
            display: flex;
            gap: 10px;
        }

        #message-input { 
            flex-grow: 1;
            width: auto;
            margin: 0;
            padding: 12px;
        }
        #send-button { 
            width: 100px; 
            padding: 12px; 
            margin: 0; 
            background: var(--accent-color); 
            color: var(--bg-dark); 
            font-size: 16px;
        }
        #send-button:hover { background: #67e8f9; transform: none; }
    </style>
    
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/simple-peer/9.11.1/simplepeer.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
</head>
<body>

    <div id="initial-form" class="card-box">
        <h2>üëã Initiate Connection</h2>
        <p>Enter your details for secure access.</p>
        <input type="text" id="userNameInput" placeholder="User Handle" maxlength="20">
        <input type="text" id="userAgeInput" placeholder="Age (18+ required)" maxlength="3">
        <button id="submitInfoBtn">Engage AI Verification</button>
        <p id="infoError" class="error-msg"></p>
    </div>

    <div id="verification-box" class="card-box" style="display:none;">
        <h2>üîê AI Protocol Check</h2>
        <p>AI is scanning... Position yourself centrally.</p>
        <video id="tempVideo" width="300" height="250" autoplay muted style="border-radius: 10px;"></video>
        <br>
        <button id="verifyBtn" disabled>Loading Neural Net...</button>
        <p id="verifyMsg"></p>
    </div>

    <div id="main-content" style="display:none;">
        <div id="video-section">
            <h1 id="welcomeHeader"></h1>
            <div id="status">Status: Connecting...</div>
            <div id="video-container">
                <video id="myVideo" autoplay muted playsinline></video>
                <video id="peerVideo" autoplay playsinline></video>
            </div>
            
            <div id="controls" style="margin-top: 20px;">
                <button id="muteBtn" class="control-btn">üîá Mute Audio</button>
                <button id="videoOffBtn" class="control-btn">üì∑ Disable Cam</button>
                <button id="nextBtn" class="control-btn" style="background: var(--accent-color); color: var(--bg-dark); display:none;">‚è© Next Stranger</button>
            </div>
        </div>
        
        <div id="chat-section">
            <h3>üí¨ Encrypted Chat Log</h3>
            <div id="messages"></div>
            <div id="message-input-container">
                <input type="text" id="message-input" placeholder="Transmit Message..." >
                <button id="send-button">Send</button>
            </div>
        </div>
    </div>

<script>
    const socket = io();
    let myStream;
    let peer;
    let userName = "User";

    // UI Elements
    const initialForm = document.getElementById('initial-form');
    const verificationBox = document.getElementById('verification-box');
    const mainContent = document.getElementById('main-content');
    const verifyBtn = document.getElementById('verifyBtn');
    const tempVideo = document.getElementById('tempVideo');
    const verifyMsg = document.getElementById('verifyMsg');
    const statusText = document.getElementById('status');
    const videoContainer = document.getElementById('video-container');
    const chatSection = document.getElementById('chat-section');
    const welcomeHeader = document.getElementById('welcomeHeader');
    
    // Form Elements
    const submitInfoBtn = document.getElementById('submitInfoBtn');
    const userNameInput = document.getElementById('userNameInput');
    const userAgeInput = document.getElementById('userAgeInput');
    const infoError = document.getElementById('infoError');

    // Chat Elements
    const messagesDiv = document.getElementById('messages');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    
    // Control Elements
    const muteBtn = document.getElementById('muteBtn');
    const videoOffBtn = document.getElementById('videoOffBtn');

    // AI Constants
    const AGE_THRESHOLD = 18;
    // CRITICAL: Path must be correct (e.g., /models) and files must be in public/models 
    const MODEL_URL = '/models'; 

    // ----------------------------------------------------
    // STAGE 1: Form Validation Logic
    // ----------------------------------------------------
    submitInfoBtn.addEventListener('click', handleInfoSubmit);
    
    function handleInfoSubmit() {
        const name = userNameInput.value.trim();
        const age = parseInt(userAgeInput.value.trim());

        infoError.textContent = ''; 

        if (name.length < 3 || !/^[a-zA-Z\s]+$/.test(name)) {
            infoError.textContent = 'User Handle must be 3+ letters only.';
            return;
        }
        if (isNaN(age) || age < 18 || age > 100) {
            infoError.textContent = 'Age must be a number between 18 and 100.';
            return;
        }

        userName = name; 
        initialForm.style.display = 'none'; 
        verificationBox.style.display = 'block'; 
        setupCameraAndModels(); 
    }


    // ----------------------------------------------------
    // STAGE 2: AI Verification Logic
    // ----------------------------------------------------
    async function setupCameraAndModels() {
        verifyMsg.innerText = "Loading AI models... (Ensure files are in public/models)";
        
        try {
            await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
            await faceapi.nets.ageGenderNet.loadFromUri(MODEL_URL);
            await faceapi.nets.faceLandmark68TinyNet.loadFromUri(MODEL_URL);

            verifyMsg.innerText = "Models loaded. Grant camera access.";
            
            const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            tempVideo.srcObject = stream;
            myStream = stream;
            verifyBtn.disabled = false; 
            verifyBtn.innerText = "Click to Scan Face";

        } catch(error) {
            console.error("Model/Camera Setup Error:", error);
            verifyMsg.innerText = "FATAL ERROR: Models not found OR Camera denied. Check Console for details.";
            verifyMsg.style.color = 'red';
        }
    }
    
    verifyBtn.addEventListener('click', async () => {
        if (!myStream || verifyBtn.disabled) return;

        verifyMsg.innerText = "Scanning and estimating age...";

        const detection = await faceapi.detectSingleFace(
            tempVideo, 
            new faceapi.TinyFaceDetectorOptions()
        ).withAgeAndGender();

        if (detection) {
            const estimatedAge = Math.round(detection.age);
            
            if (estimatedAge >= AGE_THRESHOLD) {
                // Success: Proceed to Chat Stage
                verificationBox.style.display = 'none';
                mainContent.style.display = 'flex'; 
                welcomeHeader.textContent = `Hello, ${userName}! Seeking Connection...`;
                
                tempVideo.srcObject = null; // Stop temp stream
                startChat(); 
            } else {
                verifyMsg.innerText = `Access Denied. Estimated Age: ${estimatedAge}. Must be ${AGE_THRESHOLD}+.`;
                verifyMsg.style.color = "red";
            }
        } else {
            verifyMsg.innerText = "Face not detected. Center your face and click again.";
            verifyMsg.style.color = "yellow";
        }
    });

    // ----------------------------------------------------
    // STAGE 3: Chat and WebRTC Logic (TURN/STUN FIXED)
    // ----------------------------------------------------
    function startChat() {
        videoContainer.style.display = 'flex';
        chatSection.style.display = 'block'; 
        
        document.getElementById('myVideo').srcObject = myStream;
        statusText.innerText = "Connecting to server...";
        socket.emit('join');
    }

    socket.on('waiting', (msg) => {
        statusText.innerText = msg;
    });

    socket.on('chat-start', (data) => {
        statusText.innerText = "Stranger found! Establishing P2P link...";
        
        peer = new SimplePeer({
            initiator: data.initiator,
            trickle: false,
            stream: myStream,
            config: {
                // HIGH RELIABILITY FIX: Added two different TURN servers
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    // Primary TURN Server (Relay fallback)
                    { 
                        urls: 'turn:openrelay.metered.ca:80',
                        username: 'openrelayapp', 
                        credential: 'openrelaypassword' 
                    },
                    // Secondary TURN Server (More commonly used)
                    { 
                        urls: 'turn:stun.l.google.com:19305?transport=udp',
                        username: 'webrtc', 
                        credential: 'webrtc' 
                    }
                ]
            }
        });

        peer.on('signal', signal => {
            socket.emit('signal', { signal: signal, name: userName });
        });

        peer.on('stream', stream => {
            document.getElementById('peerVideo').srcObject = stream;
            statusText.innerText = "Connection Established! Start Communication.";
        });
        
        socket.on('signal', (data) => {
            peer.signal(data.signal);
            statusText.innerText = `Connected with ${data.name}! Start Communication.`;
        });
    });

    socket.on('partner-disconnected', () => {
        statusText.innerText = "Partner connection terminated. Scanning for a new user...";
        document.getElementById('peerVideo').srcObject = null;
        if (peer) peer.destroy();
        messagesDiv.innerHTML = ''; 
        socket.emit('join');
    });

    // ----------------------------------------------------
    // STAGE 4: Text Chat Functions
    // ----------------------------------------------------

    sendButton.addEventListener('click', sendMessage);
    messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    function sendMessage() {
        const message = messageInput.value.trim();
        if (message) {
            appendMessage(userName, message, 'my-msg'); 
            socket.emit('send-message', { text: message, name: userName }); 
            messageInput.value = ''; 
        }
    }

    socket.on('receive-message', (data) => {
        appendMessage(data.name, data.text, 'stranger-msg');
    });

    function appendMessage(sender, text, className) {
        const msg = document.createElement('p');
        msg.innerHTML = `<strong>${sender}:</strong> ${text}`;
        msg.className = className; 
        msg.style.margin = '5px 0';
        messagesDiv.appendChild(msg);
        messagesDiv.scrollTop = messagesDiv.scrollHeight; 
    }

    // ----------------------------------------------------
    // STAGE 5: Controls Logic (Mute/Video Off)
    // ----------------------------------------------------

    muteBtn.addEventListener('click', () => {
        if (!myStream || myStream.getAudioTracks().length === 0) return;

        const audioTrack = myStream.getAudioTracks()[0];
        const isMuted = audioTrack.enabled; 

        audioTrack.enabled = !isMuted; 

        if (audioTrack.enabled) {
            muteBtn.innerText = 'üîá Mute Audio';
            muteBtn.style.backgroundColor = 'var(--card-dark)'; 
            muteBtn.style.color = 'var(--accent-color)';
        } else {
            muteBtn.innerText = 'üîä Unmute Audio';
            muteBtn.style.backgroundColor = 'var(--error-color)'; 
            muteBtn.style.color = 'white';
        }
    });

    videoOffBtn.addEventListener('click', () => {
        if (!myStream || myStream.getVideoTracks().length === 0) return;

        const videoTrack = myStream.getVideoTracks()[0];
        const isVideoOff = videoTrack.enabled; 

        videoTrack.enabled = !isVideoOff; 

        if (videoTrack.enabled) {
            videoOffBtn.innerText = 'üì∑ Disable Cam';
            videoOffBtn.style.backgroundColor = 'var(--card-dark)'; 
            videoOffBtn.style.color = 'var(--accent-color)';
            document.getElementById('myVideo').style.opacity = '1';
        } else {
            videoOffBtn.innerText = 'üìπ Enable Cam';
            videoOffBtn.style.backgroundColor = 'var(--error-color)'; 
            videoOffBtn.style.color = 'white';
            document.getElementById('myVideo').style.opacity = '0.3'; 
        }
    });

</script>
</body>
</html>
